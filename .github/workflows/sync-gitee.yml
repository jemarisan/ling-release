name: Sync to Gitee

on:
  push:
    branches: [main]
  release:
    types: [published, edited]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to sync (e.g. v1.4.2)'
        required: true

jobs:
  # -------------------------------------------------------
  # Job 1: Mirror repo to Gitee (code + Pages source)
  # -------------------------------------------------------
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Push to Gitee
        run: |
          git remote add gitee https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/dislab_io/ling-release.git || true
          git push gitee main --force
          git push gitee --tags --force

  # -------------------------------------------------------
  # Job 2: Sync release assets to Gitee
  # -------------------------------------------------------
  sync-release:
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: mirror
    steps:
      - name: Resolve tag
        id: info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Syncing release: $TAG"

      - name: Download release assets from GitHub
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p assets
          gh release download "${{ steps.info.outputs.tag }}" \
            --repo "${{ github.repository }}" \
            --dir assets \
            --pattern '*.apk' --pattern '*.dmg' --pattern '*.xml' || true
          echo "Downloaded assets:"
          ls -lh assets/

      - name: Create Gitee release and upload assets
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          TAG: ${{ steps.info.outputs.tag }}
        run: |
          OWNER="dislab_io"
          REPO="ling-release"
          API="https://gitee.com/api/v5"

          RELEASE_NAME=$(gh release view "$TAG" --repo "${{ github.repository }}" --json name --jq '.name' 2>/dev/null || echo "$TAG")
          RELEASE_BODY=$(gh release view "$TAG" --repo "${{ github.repository }}" --json body --jq '.body' 2>/dev/null || echo "Release $TAG")

          # Try to find existing release by listing all and matching tag
          echo "Looking for existing Gitee release with tag $TAG ..."
          RELEASE_ID=$(curl -s "$API/repos/$OWNER/$REPO/releases?access_token=$GITEE_TOKEN&page=1&per_page=100" \
            | jq -r --arg t "$TAG" '.[] | select(.tag_name == $t) | .id // empty' 2>/dev/null || echo "")

          if [ -n "$RELEASE_ID" ]; then
            echo "Found existing release: id=$RELEASE_ID"
          else
            echo "No existing release found, creating..."
            # Gitee requires target_commitish; resolve the tag's commit SHA
            TAG_SHA=$(curl -s "$API/repos/$OWNER/$REPO/tags?access_token=$GITEE_TOKEN" \
              | jq -r --arg t "$TAG" '.[] | select(.name == $t) | .commit.sha // empty' 2>/dev/null || echo "")
            TARGET="${TAG_SHA:-main}"
            echo "Using target_commitish=$TARGET"

            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API/repos/$OWNER/$REPO/releases" \
              -H "Content-Type: application/json" \
              -d "$(jq -n \
                --arg token "$GITEE_TOKEN" \
                --arg tag "$TAG" \
                --arg name "$RELEASE_NAME" \
                --arg body "$RELEASE_BODY" \
                --arg target "$TARGET" \
                '{
                  access_token: $token,
                  tag_name: $tag,
                  name: $name,
                  body: $body,
                  target_commitish: $target
                }')")

            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            RESP_BODY=$(echo "$RESPONSE" | sed '$d')
            echo "Create release HTTP $HTTP_CODE"
            echo "Response: $RESP_BODY"

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              RELEASE_ID=$(echo "$RESP_BODY" | jq -r '.id')
              echo "Gitee release created: id=$RELEASE_ID"
            else
              echo "ERROR: Could not create Gitee release. Exiting."
              exit 1
            fi
          fi

          # Upload each asset
          for FILE in assets/*; do
            [ -f "$FILE" ] || continue
            FNAME=$(basename "$FILE")
            echo "Uploading $FNAME ..."
            UPLOAD_RESP=$(curl -s -w "\n%{http_code}" -X POST \
              "$API/repos/$OWNER/$REPO/releases/$RELEASE_ID/attach_files" \
              -H "Content-Type: multipart/form-data" \
              -F "access_token=$GITEE_TOKEN" \
              -F "file=@$FILE")
            UPLOAD_CODE=$(echo "$UPLOAD_RESP" | tail -1)
            UPLOAD_BODY=$(echo "$UPLOAD_RESP" | sed '$d')
            DOWNLOAD_URL=$(echo "$UPLOAD_BODY" | jq -r '.browser_download_url // "upload failed"')
            echo "  -> HTTP $UPLOAD_CODE: $DOWNLOAD_URL"
          done

          echo "Gitee release sync complete."
